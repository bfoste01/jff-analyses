---
title: "03_Analyses"
author: "Brandon Foster, Ph.D."
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
output:
  html_document:
    df_print: paged
    toc: yes
    theme: paper
  html_notebook:
    number_sections: yes
    toc: yes
---
# Initial 

Load in the tidy data for analyses.  
```{r, initial, messages=FALSE, warning=FALSE, tidy=TRUE}
# Initialize an empty list to store the results ----
results <- list()

# Load the tidy data ----
readRDS("../data/efa.tidy.rds") -> efa.data

# Load packages ----
pacman::p_load(MplusAutomation, GPArotation, corrplot)

# Specific munging and transformations ----
items <- efa.data %>% 
  dplyr::select(-id)

# standardize items
d_items = as.data.frame(scale(items))
```

# Descriptives & Graphics

```{r, descriptives, warning=FALSE, message=FALSE, echo=TRUE, tidy=TRUE}
# Descriptives ----

# item descriptives
items <- efa.data %>% 
  dplyr::select(-id)

# descriptives
item.stats <- describe(items)
pander(item.stats)

# correlations
item.cors <- lowerCor(items)
pander(item.cors)

# Graphics ----

# munge the correlation matricies 
cormat <- reorder_cormat(item.cors)
upper_tri <- get_upper_tri(cormat)

# Melt the correlation matrix
melted_cormat <- melt(upper_tri, na.rm = TRUE)

# Create a ggheatmap
source("../functions/functions.R")
p.items.heatmap <- ggplot(melted_cormat, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "red", high = "green", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal() +
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1)) +
 coord_fixed()
print(p.items.heatmap)
results <- list(p.items.heatmap)

# corr plot with hclust sorting
corrplot(cor(na.omit(items)), order = "hclust", tl.col='black', tl.cex=.75) 
```

# Exploratory Factor Analysis

The following code will run an EFA analyses of the item level data in MPlus. R interfaces with MPlus via the 'MplusAutomation' package. As such, the code to execute the exploratory factor analyses is written in MPlus notation. The code that follows will examine the potential for up to 6 factors. The rotation utilized assumes that factors are correlated. 

## Unidimensional EFA

The model described below shows the unidimensional model with maximum likelihood extraction. 
```{r, efa.1, messages=FALSE, warning=FALSE, tidy=TRUE}
# Unidimensional EFA model ----
efa.1 <- fa(d_items, 1, fm="ml")
efa.1
```
The loading pattern in the unidimensional solution shows a moderate degree of variation, with two items having loadings greater than .70 (e.g., trackprogR and ontimeR). For these items, almost 60% of the variance in these items can be attributed to the factor model. Most of the items have loadings around .50 (see h2 in the output for the communalities). Only one item show a loading below .30, which is givelecture, and is actually negatively (i.e., -.15) associated with the factor, meaning it is likely not related to the central construct. The proportion of the total variation explained by the three factors is 30%. The uniqueness value for most items is > .70, indicating that the variance accounted for in most of the items is unaccounted for by the unidimensional factor structure. There is likely a better factor solution that explains the correlation matrix for the items. 

## Multiple Factors EFA
```{r, efa.multiple, messages=FALSE, warning=FALSE, tidy=FALSE}
# find factor solutions for 1-6 factors using a oblimin rotation
efa.2.6.oblimin <- lapply(2:6, function(x) {fa(d_items, nfactors=x, fm="ml", rotate = "oblimin")})
efa.2 <- efa.2.6.oblimin[[2]]
efa.3 <- efa.2.6.oblimin[[3]]
efa.4 <- efa.2.6.oblimin[[4]]
efa.5 <- efa.2.6.oblimin[[5]]
```
Tie for 4 to 5 factors

## Bifactor Model
```{r, efa.bifac.4, messages=FALSE, warning=FALSE, tidy=TRUE}
# Bifactor EFA models ----
# https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2981404/
# general factor for all variables and a set of residualized group factors (Schmid and Leiman (1957))
efa.4.5.bifac <- lapply(4:5, function(x) {omega(d_items, nfactors=x, sl=TRUE)})
efa.4.bifac <- efa.4.5.bifac[[1]]
efa.5.bifac <- efa.4.5.bifac[[2]]

test.4<-omega(d_items, nfactors=4, sl=TRUE)
fa.diagram(test.4,cut=.4,digits=2)
```
4 factor bifactor model fits best

## Second Order Model
```{r, efa.secondOrder, messages=FALSE, warning=FALSE, tidy=TRUE}
# correlations between the factors to represent a higher order factor (Holzinger and Swineford (1937))
efa.4.5.secondOrder <- lapply(4:5, function(x) {omega(d_items, nfactors=x, sl=FALSE)})
efa.4.5.secondOrder[[1]]
efa.4.5.secondOrder[[2]]
```

```{r, messages=FALSE, warning=FALSE}
# Save the results object ----
saveRDS(results, file = "data/results.rds")
```