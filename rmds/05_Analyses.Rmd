---
title: "05_Analyses"
author: "Brandon Foster, Ph.D."
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
output:
  html_document
---
# Introduction

This document exlores different ways to visualize the response data for the CBE items. 

# Data Vizualizations

Let's import the data and selct out the items. 
```{r, initial, messages=FALSE, warning=FALSE, tidy=TRUE}
# Initialize an empty list to store the results ----
#results <- list()

# Load the tidy data ----
readRDS("../data/efa.tidy.rds") -> efa.data

# Load any functions ----
source("../functions/functions.r")

# Load packages ----
pacman::p_load(psych, tidyverse, lavaan, pander, ggalt, ggthemes, hexbin,
               reshape2, data.table, RColorBrewer, stringr, devtools, licorice, ggthemr)
#devtools::install_github("Bart6114/licorice")
#devtools::install_github('cttobin/ggthemr')

# Specific munging and transformations ----
items <- efa.data %>% 
  dplyr::select(-id, -SCHOOL_ID)

# standardize items
d_items = as.data.frame(scale(items))

# Document options ----
panderOptions('digits', 2)
panderOptions('round', 2)
panderOptions('keep.trailing.zeros', TRUE)
```

Let's munge some of the data by creating subscales. 
```{r, munge, messages=FALSE, warning=FALSE, tidy=TRUE}
items <- efa.data %>%
  mutate(ProfProg = mastercompR + nextcompR + rubricR,
         LearnAnywhere = onlinecompR + projcredR + interncredR,
         Personalization = smallgrpR + teachdifR + givlecturR,
         FlexibleAssessment = choosehowR + retakeR + demolearnR,
         Ownership = adviceR + trackprogR + ontimeR + prepgradR,
         ProfProg.per = (ProfProg/15)*100,
         LearnAnywhere.per = (LearnAnywhere/9)*100,
         Personalization.per = (Personalization/15)*100,
         FlexibleAssessment.per = (FlexibleAssessment/14)*100,
         Ownership.per = (Ownership/20)*100)

# descriptives for items
pander(describe(items))
```

Aggregate up to the whole sample 
```{r, plots.1, messages=FALSE, warning=FALSE, tidy=TRUE}
# create aggregate subscales
items.sub <- arrange(gather(items %>%
  select(ProfProg, LearnAnywhere, Personalization, Ownership, FlexibleAssessment) %>%
  summarise("Ownership" = mean(Ownership, na.rm = TRUE),
            "Personalization" = mean(Personalization, na.rm = TRUE),
            "Proficiency-based progression" = mean(ProfProg, na.rm = TRUE),
            "Flexible assessment" = mean(FlexibleAssessment, na.rm = TRUE),
            "Learning anytime anywhere" = mean(LearnAnywhere, na.rm = TRUE)), "subscale"), -value)

# create aggregate subscales percent total
items.sub.per <- arrange(gather(items %>%
  select(ProfProg.per, LearnAnywhere.per, Personalization.per, Ownership.per, FlexibleAssessment.per) %>%
  summarise("Ownership" = mean(Ownership.per, na.rm = TRUE),
            "Personalization" = mean(Personalization.per, na.rm = TRUE),
            "Proficiency-based progression" = mean(ProfProg.per, na.rm = TRUE),
            "Flexible assessment" = mean(FlexibleAssessment.per, na.rm = TRUE),
            "Learning anytime anywhere" = mean(LearnAnywhere.per, na.rm = TRUE)), "subscale"), -value)
pander(items.sub.per)
```

Let's munge some of the data by creating subscales. 
```{r, lolipop, messages=FALSE, warning=FALSE, tidy=TRUE, results='asis'}
# lollipop plots

# total subscale
items.sub %>% 
  arrange(-value) %>% 
  ggplot(aes(x = value, y = reorder(subscale, value), label = paste0(round(value, digits = 2)))) +
        geom_segment(aes(x = 0, y = subscale, xend = value, yend = subscale), color = "grey50") +
        geom_point(size = 10) +
        geom_text(color = "white", size = 2.5) + theme_fivethirtyeight()

# percent of total
items.sub.per %>% 
  arrange(-value) %>% 
  ggplot(aes(x = value, y = reorder(subscale, value), label = paste0(round(value, 1), "%"))) +
        geom_segment(aes(x = 0, y = subscale, xend = 100, yend = subscale), color = "grey50") +
        geom_point(size = 10) +
        geom_text(color = "white", size = 2.25) + theme_fivethirtyeight()
```

# Plot Percent of Total of Subscales by School 
```{r}
# create aggregate subscales percent total
items.sub.per.school <-items %>%
  select(SCHOOL_ID, ProfProg.per, LearnAnywhere.per, Personalization.per, Ownership.per, 
         FlexibleAssessment.per) %>%
  group_by(SCHOOL_ID) %>%
  summarise("Ownership" = mean(Ownership.per, na.rm = TRUE),
            "Personalization" = mean(Personalization.per, na.rm = TRUE),
            "Proficiency-based progression" = mean(ProfProg.per, na.rm = TRUE),
            "Flexible assessment" = mean(FlexibleAssessment.per, na.rm = TRUE),
            "Learning anytime anywhere" = mean(LearnAnywhere.per, na.rm = TRUE))

# convert data
items.sub.per.school <- gather(items.sub.per.school, subscale, value, -SCHOOL_ID)
items.sub.per.school$value <- as.numeric(items.sub.school$value)
items.sub.per.school$SCHOOL_ID <- as.factor(items.sub.school$SCHOOL_ID)

# lolipop by group
p.subPer.school <- ggplot(items.sub.per.school) + 
  geom_linerange(aes(x = subscale, ymin = 0, ymax = 100, group = subscale), 
                 position = position_dodge(width = 1)) +
  geom_point(aes(x = subscale, y = value, group = subscale, color = SCHOOL_ID),
                 position = position_dodge(width = 1)) +
    coord_flip() +
  ggtitle("School-level Variability in CBE", 
    subtitle = "School average percent of total score on subscales for CBE implementation") + 
    labs(colour = "Schools")

# apply aesthetic themes to plot
p.subPer.school.theme <- p.subPer.school + scale_color_gdocs() + theme_fivethirtyeight()

# save the plot
ggsave("../plots/p.subPer.school.theme.png", p.subPer.school.theme, width = 8, 
    height = 5)
```

# Plot Average Total Score for Subscales by School 
```{r}
# create aggregate subscales by school
items.sub.tot.school <- items %>%
  select(SCHOOL_ID, ProfProg, LearnAnywhere, Personalization, Ownership, FlexibleAssessment) %>%
  group_by(SCHOOL_ID) %>%
  summarise("Ownership" = mean(Ownership, na.rm = TRUE),
            "Personalization" = mean(Personalization, na.rm = TRUE),
            "Proficiency-based progression" = mean(ProfProg, na.rm = TRUE),
            "Flexible assessment" = mean(FlexibleAssessment, na.rm = TRUE),
            "Learning anytime anywhere" = mean(LearnAnywhere, na.rm = TRUE))

# convert data
items.sub.tot.school <- gather(items.sub.tot.school, subscale, value, -SCHOOL_ID)
items.sub.tot.school$value <- as.numeric(items.sub.tot.school$value)
items.sub.tot.school$SCHOOL_ID <- as.factor(items.sub.tot.school$SCHOOL_ID)

# lolipop by group
p.subTot.school <- ggplot(items.sub.tot.school) + 
  geom_linerange(aes(x = subscale, ymin = 0, ymax = value, group = subscale), 
                 position = position_dodge(width = 1)) +
  geom_point(aes(x = subscale, y = value, group = subscale, color = SCHOOL_ID),
                 position = position_dodge(width = 1)) +
    coord_flip() +
  ggtitle("School-level Variability in CBE", 
    subtitle = "School average total score on subscales for CBE implementation") + 
    labs(colour = "Schools")

# apply aesthetic themes to plot
p.subTot.school.theme <- p.subTot.school + scale_color_gdocs() + theme_fivethirtyeight()

# save the plot
ggsave("../plots/p.subTot.school.theme.png", p.subTot.school.theme, width = 8, 
    height = 5)
```

# Licorice Proficiency-based Progression
```{r}
# select oute items for 
ProfProg.items <- gather(select(items, mastercompR, nextcompR, rubricR), item, value)

# create count table 
ProfProg.count <- ProfProg.items %>%
  group_by(item)%>%
  count(value)%>%
  mutate(value = as.factor(value)) %>%
  rename(question = item, 
         count = n,
         response = value)

# recode the likert scale values
ProfProg.count$response <- dplyr::recode_factor(ProfProg.count$response, "0" = "Never", "1" = "Seldom", 
                                                "2" = "Sometimes", "3" = "Often", "4" = "Always")

table(ProfProg.count$question)

ProfProg.count$question <- dplyr::recode_factor(ProfProg.count$question, 
                                                "mastercompR" = "Show proficiency", 
                                                "nextcompR" = "Next standard", 
                                                "rubricR" = "Given rubric")
# set order for plots
my_order <- c("Never","Seldom", "Sometimes", "Often", "Always")

# set ggthemr theme
ggthemr_reset()
ggthemr('flat', type = 'outer', layout = 'minimal', spacing = 1.25)
swatch()
to_swap <- swatch()[1:5]

# plot it in licorice!
p.ProfProg <- licorice(ProfProg.count, answers_order = my_order, middle_pos = 2.5, 
                       type = "center", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.ProfProg <- p.ProfProg + scale_fill_manual(values = rev(to_swap))
p.ProfProg
ggsave("../plots/p.ProfProg.png", p.ProfProg, width = 8, 
    height = 5)

# plot fill
p.ProfProg.fill <- licorice(ProfProg.count, answers_order = my_order, middle_pos = 2, 
                            type = "fill", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.ProfProg.fill <- p.ProfProg.fill + scale_fill_manual(values = rev(to_swap))
p.ProfProg.fill
ggsave("../plots/p.ProfProg.fill.png", p.ProfProg.fill, width = 8, 
    height = 5)
```

# Licorice Learning anytime and anywhere
```{r}
# select oute items for 
LearnAnywhere.items <- gather(select(items, onlinecompR, projcredR, interncredR), item, value)
table(LearnAnywhere.items)

# create count table 
LearnAnywhere.count <- LearnAnywhere.items %>%
  group_by(item)%>%
  count(value)%>%
  mutate(value = as.factor(value)) %>%
  rename(question = item, 
         count = n,
         response = value)

# recode the likert scale values
LearnAnywhere.count$response <- dplyr::recode_factor(LearnAnywhere.count$response, "0" = "No course", 
                                                     "1" =  "Some courses", "2" = "All courses")

LearnAnywhere.count$question <- dplyr::recode_factor(LearnAnywhere.count$question, 
                                                     "onlinecompR" = "Take online", 
                                                     "projcredR" = "Project credit", 
                                                     "interncredR" = "Internship")
# set order for plots
my_order <- c("No course","Some courses", "All courses")

# set ggthemr theme
ggthemr_reset()
ggthemr('flat', type = 'outer', layout = 'minimal', spacing = 1.25)
swatch()
to_swap <- swatch()[1:5]

# plot it in licorice!
p.LearnAnywhere <- licorice(LearnAnywhere.count, answers_order = my_order, middle_pos = 1.5, 
                            type = "center", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.LearnAnywhere <- p.LearnAnywhere + scale_fill_manual(values = rev(to_swap))
p.LearnAnywhere
ggsave("../plots/p.LearnAnywhere.png", p.LearnAnywhere, width = 8, 
    height = 5)

# plot fill
p.LearnAnywhere.fill <- licorice(LearnAnywhere.count, answers_order = my_order, middle_pos = 2, 
                            type = "fill", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.LearnAnywhere.fill <- p.LearnAnywhere.fill + scale_fill_manual(values = rev(to_swap))
p.LearnAnywhere.fill
ggsave("../plots/p.LearnAnywhere.fill.png", p.LearnAnywhere.fill, width = 8, 
    height = 5)
```

# Licorice Personalization 
```{r}
# select oute items for 
Personalization.items <- gather(select(items, smallgrpR, teachdifR, givlecturR), item, value)
table(Personalization.items)

# create count table 
Personalization.count <- Personalization.items %>%
  group_by(item)%>%
  count(value)%>%
  mutate(value = as.factor(value)) %>%
  rename(question = item, 
         count = n,
         response = value)

# recode the likert scale values
Personalization.count$response <- dplyr::recode_factor(Personalization.count$response, "0" = "Never", 
                                                       "1" = "Seldom","2" = "Sometimes", "3" = "Often", 
                                                       "4" = "Always")

Personalization.count$question <- dplyr::recode_factor(Personalization.count$question,
                                                       "smallgrpR" = "Small group", 
                                                       "teachdifR" = "Multiple modes", 
                                                       "givlecturR" = "Lectured at")
# set order for plots
my_order <- c("Never","Seldom", "Sometimes", "Often", "Always")

# set ggthemr theme
ggthemr_reset()
ggthemr('flat', type = 'outer', layout = 'minimal', spacing = 1.25)
swatch()
to_swap <- swatch()[1:5]

# plot it in licorice!
p.Personalization <- licorice(Personalization.count, answers_order = my_order, middle_pos = 2.5, 
                            type = "center", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.Personalization <- p.Personalization + scale_fill_manual(values = rev(to_swap))
p.Personalization
ggsave("../plots/p.Personalization.png", p.Personalization, width = 8, 
    height = 5)

# plot fill
p.Personalization.fill <- licorice(Personalization.count, answers_order = my_order, middle_pos = 2, 
                            type = "fill", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.Personalization.fill <- p.Personalization.fill + scale_fill_manual(values = rev(to_swap))
p.Personalization.fill
ggsave("../plots/p.Personalization.fill.png", p.Personalization.fill, width = 8, 
    height = 5)
```


# Licorice Ownership 
```{r}
# select oute items for 
Ownership.items <- gather(select(items, adviceR, trackprogR, ontimeR, prepgradR), item, value)
table(Ownership.items)

# create count table 
Ownership.count <- Ownership.items %>%
  group_by(item)%>%
  count(value)%>%
  mutate(value = as.factor(value)) %>%
  rename(question = item, 
         count = n,
         response = value)

# recode the likert scale values
Ownership.count$response <- dplyr::recode_factor(Ownership.count$response, "0" = "Never", 
                                                       "1" = "Seldom","2" = "Sometimes", "3" = "Often", 
                                                       "4" = "Always")

Ownership.count$question <- dplyr::recode_factor(Ownership.count$question,
                                                       "adviceR" = "Strategies to progress", 
                                                       "ontimeR" = "Strategies on time", 
                                                       "prepgradR" = "Prepare post-grad",
                                                        "trackprogR" = "Strategies for progress" )
# set order for plots
my_order <- c("Never","Seldom", "Sometimes", "Often", "Always")

# set ggthemr theme
ggthemr_reset()
ggthemr('flat', type = 'outer', layout = 'minimal', spacing = 1.25)
swatch()
to_swap <- swatch()[1:5]

# plot it in licorice!
p.Ownership <- licorice(Ownership.count, answers_order = my_order, middle_pos = 2.5, 
                            type = "center", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.Ownership <- p.Ownership + scale_fill_manual(values = rev(to_swap))
p.Ownership
ggsave("../plots/p.Ownership.png", p.Ownership, width = 8, 
    height = 5)

# plot fill
p.Ownership.fill <- licorice(Ownership.count, answers_order = my_order, middle_pos = 1, 
                            type = "fill", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.Ownership.fill <- p.Ownership.fill + scale_fill_manual(values = rev(to_swap))
p.Ownership.fill
ggsave("../plots/p.Ownership.fill.png", p.Ownership.fill, width = 8, 
    height = 5)
```

# Licorice Flexible Assessment  
```{r}
# select oute items for 
Flexible.items <- gather(select(items, retakeR, demolearnR), item, value)
table(Ownership.items)

# create count table 
Flexible.count <- Flexible.items %>%
  group_by(item)%>%
  count(value)%>%
  mutate(value = as.factor(value)) %>%
  rename(question = item, 
         count = n,
         response = value)

# recode the likert scale values
Flexible.count$response <- dplyr::recode_factor(Flexible.count$response, "0" = "Never", 
                                                       "1" = "Seldom","2" = "Sometimes", "3" = "Often", 
                                                       "4" = "Always")

Flexible.count$question <- dplyr::recode_factor(Flexible.count$question,
                                                       "retakeR" = "Retry assessments", 
                                                       "demolearnR" = "Demonstrate learning")

# set order for plots
my_order <- c("Never","Seldom", "Sometimes", "Often", "Always")

# set ggthemr theme
ggthemr_reset()
ggthemr('flat', type = 'outer', layout = 'minimal', spacing = 1.25)
swatch()
to_swap <- swatch()[1:5]

# plot it in licorice!
p.Flexible <- licorice(Flexible.count, answers_order = my_order, middle_pos = 2.5, 
                            type = "center", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.Flexible <- p.Flexible + scale_fill_manual(values = rev(to_swap))
p.Flexible
ggsave("../plots/p.Flexible.png", p.Flexible, width = 8, 
    height = 5)

# plot fill
p.Flexible.fill <- licorice(Flexible.count, answers_order = my_order, middle_pos = 1, 
                            type = "fill", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.Flexible.fill <- p.Flexible.fill + scale_fill_manual(values = rev(to_swap))
p.Flexible.fill
ggsave("../plots/p.Flexible.fill.png", p.Flexible.fill, width = 8, 
    height = 5)

# select oute items for final flexible assessment item

Flexible.items.2 <- gather(select(items, choosehowR), item, value)
table(Flexible.items.2)

# create count table 
Flexible.count.2 <- Flexible.items.2 %>%
  group_by(item)%>%
  count(value)%>%
  mutate(value = as.factor(value)) %>%
  rename(question = item, 
         count = n,
         response = value)

# recode the likert scale values
Flexible.count.2$response <- dplyr::recode_factor(Flexible.count.2$response, "0" = "Not at all", 
                                                       "1" = "1 to 2 times", "2" = "3 to 4 times", 
                                                       "3" = "5 or more times")

Flexible.count.2$question <- dplyr::recode_factor(Flexible.count.2$question,
                                                       "choosehowR" = "Show learning")

# set order for plots
my_order <- c("Not at all","1 to 2 times", "3 to 4 times", "5 or more times")

# set ggthemr theme
ggthemr_reset()
ggthemr('flat', type = 'outer', layout = 'minimal', spacing = 1.25)
swatch()
to_swap <- swatch()[1:5]

# plot it in licorice!
p.Flexible.2 <- licorice(Flexible.count.2, answers_order = my_order, middle_pos = 1, 
                            type = "center", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.Flexible <- p.Flexible + scale_fill_manual(values = rev(to_swap))
p.Flexible
ggsave("../plots/p.Flexible.2.png", p.Flexible.2, width = 8, 
    height = 5)

# plot fill
p.Flexible.fill.2 <- licorice(Flexible.count.2, answers_order = my_order, middle_pos = 1, 
                            type = "fill", sort=T) + 
  ggtitle("Variability in the Responses to Items") + 
  labs(x = 'Questions', fill = 'Response') +
  theme(legend.position = 'bottom')
p.Flexible.fill.2 <- p.Flexible.fill.2 + scale_fill_manual(values = rev(to_swap))
p.Flexible.fill.2
ggsave("../plots/p.Flexible.fill.2.png", p.Flexible.fill.2, width = 8, 
    height = 5)
```

# NA Proficiency-based Progression 
```{r}
# create count of missing 
items.long <- gather(items)
items.na <- items.long %>%
  group_by(key)%>%
  count(is.na(value)) %>%
  rename(response = "is.na(value)",
         question = key, 
         count = n) %>%
  mutate(response = as.factor(response)) 

# lable items
items.na$question <- dplyr::recode_factor(items.na$question,
                                          "adviceR" = "Strategies to progress", 
                                          "ontimeR" = "Strategies on time", 
                                          "prepgradR" = "Prepare post-grad",
                                          "trackprogR" = "Strategies for progress",
                                          "smallgrpR" = "Small group", 
                                          "teachdifR" = "Multiple modes", 
                                          "givlecturR" = "Lectured at", 
                                          "onlinecompR" = "Take online", 
                                          "projcredR" = "Project credit", 
                                          "interncredR" = "Internship",
                                          "mastercompR" = "Show proficiency", 
                                          "nextcompR" = "Next standard", 
                                          "rubricR" = "Given rubric",
                                          "retakeR" = "Retry assessments", 
                                          "demolearnR" = "Demonstrate learning",
                                          "choosehowR" = "Show learning")

# recode logical values to not missing and missing
items.na$response <- dplyr::recode(items.na$response, "FALSE" = "Not Missing", "TRUE" = "Missing")
items.na

# set ggthemr theme
ggthemr_reset()
ggthemr('flat', type = 'outer', layout = 'minimal', spacing = 1.25)
swatch()
to_swap <- swatch()[1:4]

# plot
my_order_na <- c("Missing","Not Missing")

p.na <- licorice(items.na, answers_order = my_order_na, middle_pos = 1, 
                 type = "center", sort=TRUE) + 
  ggtitle("Percent Missing for All CBE Items") + 
  labs(x = 'Questions') +
  theme(legend.position = 'bottom')
p.na <- p.na + scale_fill_manual(values = rev(to_swap))

ggsave("../plots/p.na.png", p.na, width = 8, height = 5)

```
  